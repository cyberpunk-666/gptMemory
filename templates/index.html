<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
        }
        input[type="text"], input[type="date"] {
            padding: 5px;
            margin: 5px 0;
            width: calc(100% - 12px);
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Ace Editor styles */
        #newMemoryEditor, #editMemoryEditor {
            height: 200px;
            width: 100%;
            border: 1px solid #ccc;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.13/ace.js"></script>
</head>
<body>
    <h1>Memory Manager</h1>

    <h2>Filters</h2>
    <label for="filterTitle">Title:</label>
    <input type="text" id="filterTitle" oninput="filterMemories()">
    <label for="filterDate">Date:</label>
    <input type="date" id="filterDate" oninput="filterMemories()">

    <h2>Memories</h2>
    <table id="memoryTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Title</th>
                <th>Content</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <button onclick="fetchMemories()">Refresh Memories</button>

    <h2>Add New Memory</h2>
    <button onclick="openAddModal()">Add Memory</button>

    <!-- Modal for Adding New Memory -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addModal')">&times;</span>
            <h2>Add New Memory</h2>
            <label for="newMemoryTitle">Title:</label>
            <input type="text" id="newMemoryTitle">
            <label for="newMemoryContent">Content:</label>
            <div id="newMemoryEditor"></div><br>
            <button onclick="addMemory()">Save Memory</button>
        </div>
    </div>

    <!-- Modal for Editing Memory -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h2>Edit Memory</h2>
            <label for="editMemoryDate">Date:</label>
            <input type="date" id="editMemoryDate" readonly>
            <label for="editMemoryTitle">Title:</label>
            <input type="text" id="editMemoryTitle">
            <label for="editMemoryContent">Content:</label>
            <div id="editMemoryEditor"></div><br>
            <button onclick="saveMemory()">Save Changes</button>
        </div>
    </div>

    <script>
        let currentEditId = null;
        let newMemoryEditor;
        let editMemoryEditor;
        let allMemories = [];

        function initEditors() {
            newMemoryEditor = ace.edit("newMemoryEditor");
            newMemoryEditor.setTheme("ace/theme/github");
            newMemoryEditor.session.setMode("ace/mode/json");

            editMemoryEditor = ace.edit("editMemoryEditor");
            editMemoryEditor.setTheme("ace/theme/github");
            editMemoryEditor.session.setMode("ace/mode/json");
        }

        function fetchMemories() {
            fetch('/retrieve-memory')
                .then(response => response.json())
                .then(data => {
                    allMemories = data;  // Save all memories for filtering
                    displayMemories(data);
                });
        }

        function displayMemories(memories) {
            const tableBody = document.getElementById('memoryTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            memories.forEach(memory => {
                const formattedDate = formatDate(memory.memory_data.date);
                const row = tableBody.insertRow();
                row.insertCell(0).innerHTML = memory.id;
                row.insertCell(1).innerHTML = formattedDate || 'N/A';
                row.insertCell(2).innerHTML = memory.memory_data.title || 'N/A';
                row.insertCell(3).innerHTML = memory.memory_data.content || 'N/A';
                const actionsCell = row.insertCell(4);
                actionsCell.innerHTML = `
                    <button onclick="openEditModal(${memory.id})">Edit</button>
                    <button onclick="deleteMemory(${memory.id})">Delete</button>
                `;
            });
        }

        function formatDate(isoDate) {
            if (!isoDate) return 'N/A';
            const date = new Date(isoDate);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function filterMemories() {
            const filterTitle = document.getElementById('filterTitle').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;
            const filteredMemories = allMemories.filter(memory => {
                const titleMatch = memory.memory_data.title.toLowerCase().includes(filterTitle);
                const dateMatch = filterDate ? memory.memory_data.date === filterDate : true;
                return titleMatch && dateMatch;
            });
            displayMemories(filteredMemories);
        }

        function openAddModal() {
            newMemoryEditor.setValue('', -1); // Start with an empty template
            document.getElementById('newMemoryTitle').value = '';
            document.getElementById('addModal').style.display = 'block';
        }

        function addMemory() {
            const title = document.getElementById('newMemoryTitle').value;
            const content = newMemoryEditor.getValue();
            const memoryData = {
                title: title,
                content: content
            };
            fetch('/store-memory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ memory_data: memoryData })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchMemories();
                closeModal('addModal');
            });
        }

        function openEditModal(id) {
            currentEditId = id;
            const memory = allMemories.find(m => m.id === id);
            document.getElementById('editMemoryDate').value = memory.memory_data.date || '';
            document.getElementById('editMemoryTitle').value = memory.memory_data.title || '';
            editMemoryEditor.setValue(memory.memory_data.content || '', -1);
            document.getElementById('editModal').style.display = 'block';
        }

        function saveMemory() {
            const title = document.getElementById('editMemoryTitle').value;
            const content = editMemoryEditor.getValue();
            const memoryData = {
                id: currentEditId,
                memory_data: {
                    date: document.getElementById('editMemoryDate').value,
                    title: title,
                    content: content
                }
            };
            fetch('/modify-memory', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(memoryData)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                fetchMemories();
                closeModal('editModal');
            });
        }

        function deleteMemory(id) {
            if (confirm('Are you sure you want to delete this memory?')) {
                fetch('/delete-memory', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    fetchMemories();
                });
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Initialize Ace Editors on page load
        window.onload = function() {
            initEditors();
            fetchMemories();
        };

        // Close the modal if the user clicks outside of it
        window.onclick = function(event) {
            if (event.target.className.includes('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>



</body>
</html>
